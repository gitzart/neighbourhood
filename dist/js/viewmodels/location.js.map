{"version":3,"sources":["viewmodels/location.js"],"names":["define","$","ko","GoogleMap","Location","LocationViewModel","data","self","this","destinations","observable","bounds","map","create","info","observableArray","venues","keyword","focusedLocation","hasError","d","index","marker","id","position","title","name","animation","isFavorite","addIcon","infoWindow","content","maxWidth","destination","nearbyVenues","overlayMap","extend","_marker","getPosition","event","click","bounce","open","trigger","resize","_map","setOptions","center","zoom","setMap","findNearbyVenues","mouseOver","mouseOut","close","fit","saveDestinations","dests","o","localStorage","setItem","toJSON","filter","re","RegExp","trim","each","test","show","isFiltered","hide","openInfoWindow","location","closeInfoWindow","toggleInfoWindow","evt","type","isActive","toggleFavorite","removeIcon","closeOverlay","showInMap","venue","dest","v","length","get","ll","lat","lng","venuePhotos","client_id","foursquareAPI","clientID","client_secret","clientSecret","version","done","status","xhr","response","groups","items","address","street","formattedAddress","state","country","category","categories","icon","prefix","suffix","photo","photos","rating","tip","tips","text","fail","error","console","log","somosAssassinos","featureType","elementType","stylers","visibility","saturation","color","lightness","weight","document","querySelector","styles"],"mappings":"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","file":"location.js","sourcesContent":["define([\n  'jquery',\n  'knockout',\n  'googlemap',\n  'models/Location',\n], function($, ko, GoogleMap, Location) {\n  'use strict';\n\n  // Map style provided by https://snazzymaps.com and\n  // https://snazzymaps.com/style/72543/assassins-creed-iv\n  var somosAssassinos = [{\"featureType\":\"all\",\"elementType\":\"all\",\"stylers\":[{\"visibility\":\"on\"}]},{\"featureType\":\"all\",\"elementType\":\"labels\",\"stylers\":[{\"saturation\":\"-100\"},{\"visibility\":\"off\"}]},{\"featureType\":\"all\",\"elementType\":\"labels.text.fill\",\"stylers\":[{\"saturation\":36},{\"color\":\"#d5c8a5\"},{\"lightness\":40},{\"visibility\":\"on\"}]},{\"featureType\":\"all\",\"elementType\":\"labels.text.stroke\",\"stylers\":[{\"visibility\":\"off\"},{\"lightness\":16},{\"color\":\"#000000\"}]},{\"featureType\":\"all\",\"elementType\":\"labels.icon\",\"stylers\":[{\"visibility\":\"on\"}]},{\"featureType\":\"administrative\",\"elementType\":\"geometry.fill\",\"stylers\":[{\"color\":\"#000000\"},{\"lightness\":20}]},{\"featureType\":\"administrative\",\"elementType\":\"geometry.stroke\",\"stylers\":[{\"color\":\"#000000\"},{\"lightness\":17},{\"weight\":1.2}]},{\"featureType\":\"landscape\",\"elementType\":\"geometry\",\"stylers\":[{\"lightness\":20},{\"color\":\"#000000\"}]},{\"featureType\":\"landscape\",\"elementType\":\"geometry.fill\",\"stylers\":[{\"color\":\"#4d6059\"}]},{\"featureType\":\"landscape\",\"elementType\":\"geometry.stroke\",\"stylers\":[{\"color\":\"#4d6059\"}]},{\"featureType\":\"landscape.natural\",\"elementType\":\"geometry.fill\",\"stylers\":[{\"color\":\"#604d4d\"}]},{\"featureType\":\"poi\",\"elementType\":\"geometry\",\"stylers\":[{\"lightness\":21}]},{\"featureType\":\"poi\",\"elementType\":\"geometry.fill\",\"stylers\":[{\"color\":\"#30423d\"}]},{\"featureType\":\"poi\",\"elementType\":\"geometry.stroke\",\"stylers\":[{\"color\":\"#30423d\"}]},{\"featureType\":\"road\",\"elementType\":\"geometry\",\"stylers\":[{\"visibility\":\"on\"},{\"color\":\"#7f8d89\"}]},{\"featureType\":\"road\",\"elementType\":\"geometry.fill\",\"stylers\":[{\"color\":\"#7f8d89\"}]},{\"featureType\":\"road.highway\",\"elementType\":\"geometry.fill\",\"stylers\":[{\"color\":\"#44474e\"},{\"lightness\":17}]},{\"featureType\":\"road.highway\",\"elementType\":\"geometry.stroke\",\"stylers\":[{\"color\":\"#7f8d89\"},{\"lightness\":29},{\"weight\":0.2}]},{\"featureType\":\"road.arterial\",\"elementType\":\"geometry\",\"stylers\":[{\"color\":\"#000000\"},{\"lightness\":18}]},{\"featureType\":\"road.arterial\",\"elementType\":\"geometry.fill\",\"stylers\":[{\"color\":\"#3e5851\"}]},{\"featureType\":\"road.arterial\",\"elementType\":\"geometry.stroke\",\"stylers\":[{\"color\":\"#3e5851\"}]},{\"featureType\":\"road.local\",\"elementType\":\"geometry\",\"stylers\":[{\"color\":\"#000000\"},{\"lightness\":16}]},{\"featureType\":\"road.local\",\"elementType\":\"geometry.fill\",\"stylers\":[{\"color\":\"#3e5851\"}]},{\"featureType\":\"road.local\",\"elementType\":\"geometry.stroke\",\"stylers\":[{\"color\":\"#3e5851\"}]},{\"featureType\":\"transit\",\"elementType\":\"geometry\",\"stylers\":[{\"color\":\"#000000\"},{\"lightness\":19},{\"visibility\":\"off\"}]},{\"featureType\":\"water\",\"elementType\":\"all\",\"stylers\":[{\"color\":\"#2b3638\"},{\"visibility\":\"on\"}]},{\"featureType\":\"water\",\"elementType\":\"geometry\",\"stylers\":[{\"color\":\"#2b3638\"},{\"lightness\":17}]},{\"featureType\":\"water\",\"elementType\":\"geometry.fill\",\"stylers\":[{\"color\":\"#24282b\"}]},{\"featureType\":\"water\",\"elementType\":\"geometry.stroke\",\"stylers\":[{\"color\":\"#24282b\"}]},{\"featureType\":\"water\",\"elementType\":\"labels\",\"stylers\":[{\"visibility\":\"off\"}]},{\"featureType\":\"water\",\"elementType\":\"labels.text\",\"stylers\":[{\"visibility\":\"off\"}]},{\"featureType\":\"water\",\"elementType\":\"labels.text.fill\",\"stylers\":[{\"visibility\":\"off\"}]},{\"featureType\":\"water\",\"elementType\":\"labels.text.stroke\",\"stylers\":[{\"visibility\":\"off\"}]},{\"featureType\":\"water\",\"elementType\":\"labels.icon\",\"stylers\":[{\"visibility\":\"off\"}]}];\n\n  var map = new GoogleMap().create(document.querySelector('#map-canvas'), {\n    center: {lat: 40.7713024, lng: -73.9332393},\n    zoom: 8,\n    styles: somosAssassinos,\n  });\n  var overlayMap = new GoogleMap().create(\n    document.querySelector('#overlay-map-canvas'));\n  var foursquareAPI = {\n    version: '20170410',\n    clientID: '1C1I0SPV4ZZ4YDKCGFAIJ3BLE0MLOM3RDW1SYKBKUSXLOXIE',\n    clientSecret: 'G0NPXGT4NMLOH0W2CWBZEA5HPAYKXUNAHD55YT21AGPMPXYM',\n  };\n\n  function LocationViewModel(data) {\n    var self = this;\n\n    self.destinations = ko.observable({\n      bounds: map.bounds().create(),\n      info: ko.observableArray(),\n    });\n    self.venues = ko.observable({});\n    self.keyword = ko.observable();\n    self.focusedLocation = ko.observable();\n    self.hasError = ko.observable(false);\n\n    // Initialize destination data\n    self.destinations().info($.map(data, function(d, index) {\n      var marker = map.marker().create({\n        id: index,\n        position: d.position,\n        title: d.name,\n        animation: true,\n      });\n\n      if (d.isFavorite) {\n        marker.addIcon('https://maps.google.com/mapfiles/ms/icons/green-dot.png');\n      }\n\n      var infoWindow = map.infoWindow().create({\n        id: index,\n        content: d.name,\n        maxWidth: 200,\n      });\n\n      // Create new `Location` instance and add new properties.\n      var destination = new Location(index, d.name, d.position,\n                                     marker, infoWindow, d.isFavorite);\n      destination.nearbyVenues = {\n        bounds: overlayMap.bounds().create(),\n        info: ko.observableArray(),\n      };\n\n      self.destinations().bounds.extend(marker._marker.getPosition());\n\n      // Add marker events\n      marker.event.click(function() {\n        marker.bounce();\n        infoWindow.open(marker._marker);\n        if (!self.focusedLocation()) {\n          self.focusedLocation(destination);\n          // Move `destination` marker to the `overlayMap`.\n          overlayMap.trigger.resize();\n          overlayMap._map.setOptions({\n            center: destination.position,\n            zoom: 16,\n          });\n          destination.marker._marker.setMap(overlayMap._map);\n          self.findNearbyVenues(destination);\n        }\n      })\n        .mouseOver(function() {\n          if (!self.focusedLocation()) {\n            infoWindow.open(marker._marker);\n          }\n        })\n        .mouseOut(function() {\n          if (!self.focusedLocation()) {\n            infoWindow.close();\n          }\n        });\n\n      // Add infoWindow events\n      infoWindow.event.close(function() {\n        infoWindow.close();\n      });\n\n      return destination;\n    }));\n\n    // Bound initially when the destination data loads.\n    self.destinations().bounds.fit();\n\n    // Save the destinations to the localStorage.\n    self.saveDestinations = function() {\n      var dests = self.destinations().info();\n      var o = ko.observableArray($.map(dests, function(d, index) {\n        return {\n          id: d.id,\n          name: d.name,\n          position: d.position,\n          isFavorite: d.isFavorite,\n        };\n      }));\n      localStorage.setItem('destinations', ko.toJSON(o));\n    };\n\n    // Save the destinations initially\n    self.saveDestinations();\n\n    // Search the destinations\n    self.filter = function() {\n      var re = new RegExp(self.keyword().trim(), 'i');\n      $.each(self.destinations().info(), function(index, d) {\n        if (re.test(d.name)) {\n          d.marker.show();\n          d.isFiltered(true);\n        } else {\n          d.marker.hide();\n          d.isFiltered(false);\n        }\n      });\n    };\n\n    // Open, close, or toggle the infoWindow of `Location` instances.\n    // Both destinations and venues.\n    self.openInfoWindow = function(location) {\n      location.marker.trigger.click();\n    };\n\n    self.closeInfoWindow = function(location) {\n      location.infoWindow.trigger.close();\n    };\n\n    self.toggleInfoWindow = function(location, evt) {\n      // Marker events of `destinations` and `venues` are\n      // defined differently.\n      // Destination marker events\n      if (evt.type === 'mouseover') {\n        location.marker.trigger.mouseOver();\n      } else if (evt.type === 'mouseout') {\n        location.marker.trigger.mouseOut();\n      }\n\n      // Venue marker events\n      if (evt.type === 'click') {\n        if (location.infoWindow.isActive) {\n          location.infoWindow.isActive = false;\n          self.closeInfoWindow(location);\n        } else {\n          location.infoWindow.isActive = true;\n          self.openInfoWindow(location);\n        }\n      }\n    };\n\n    // Mark/unmark a favorite destination.\n    self.toggleFavorite = function(destination) {\n      if (destination.isFavorite()) {\n        destination.marker.removeIcon();\n      } else {\n        destination.marker.addIcon('https://maps.google.com/mapfiles/ms/icons/green-dot.png');\n      }\n      destination.isFavorite(!destination.isFavorite());\n      self.saveDestinations();\n    };\n\n    // Close the overlay HTML\n    self.closeOverlay = function() {\n      self.focusedLocation().marker._marker.setMap(map._map);\n      self.focusedLocation(false);\n    };\n\n    // Show the destination and venue markers on the map.\n    self.showInMap = function(venue) {\n      var dest = self.focusedLocation();\n      // Hide previously opened markers and infowindows.\n      $.each(dest.nearbyVenues.info(), function(index, v) {\n        v.marker.hide();\n        self.closeInfoWindow(v);\n      });\n      // Fixed the bounding bug\n      // BUG: `infoWindow` takes its own space when opened\n      // which results in some markers, when bounded, cannot be seen,\n      // clipped, hidden by the map viewport.\n      self.closeInfoWindow(dest);\n      venue.marker.show();\n      overlayMap.bounds().create()\n        .extend(dest.position)\n        .extend(venue.position)\n        .fit();\n    };\n\n    // Find the interesting venues around the selected destination.\n    self.findNearbyVenues = function(dest) {\n      if (dest.nearbyVenues.info().length) {\n        self.venues(dest.nearbyVenues);\n        return;\n      }\n\n      // Reset the `venues` instance.\n      self.venues({});\n      self.hasError(false);\n\n      // Fetch the data if not done already.\n      $.get('https://api.foursquare.com/v2/venues/explore', {\n        ll: dest.position.lat + ',' + dest.position.lng,\n        venuePhotos: true,\n        // limit: 5,\n        client_id: foursquareAPI.clientID,\n        client_secret: foursquareAPI.clientSecret,\n        v: foursquareAPI.version,\n      })\n        .done(function(data, status, xhr) {\n          var venues = data.response.groups[0].items;\n\n          if (venues.length === 0) {\n            self.hasError('No venues exist :(');\n            return;\n          }\n\n          dest.nearbyVenues.info($.map(venues, function(v, index) {\n            var name = v.venue.name;\n\n            var position = {\n              lat: v.venue.location.lat,\n              lng: v.venue.location.lng,\n            };\n\n            var marker = overlayMap.marker().create({\n              id: index,\n              position: position,\n              title: name,\n            })\n              .addIcon('https://maps.google.com/mapfiles/ms/icons/yellow-dot.png')\n              .hide();\n\n            var infoWindow = overlayMap.infoWindow().create({\n              id: index,\n              content: name,\n              maxWidth: 200,\n            });\n\n            // Create new `Location` instance and add new properties\n            var venue = new Location(v.venue.id, name, position,\n                                     marker, infoWindow);\n            venue.address = {\n              street: v.venue.location.formattedAddress[0],\n              state: v.venue.location.formattedAddress[1],\n              country: v.venue.location.formattedAddress[2],\n            };\n            venue.category = {\n              name: v.venue.categories[0].name,\n              icon: v.venue.categories[0].icon.prefix +\n                '32' + v.venue.categories[0].icon.suffix,\n            };\n            venue.photo = v.venue.photos.groups[0].items[0].prefix +\n              'width320' + v.venue.photos.groups[0].items[0].suffix;\n            venue.rating = v.venue.rating;\n            venue.tip = v.tips ? v.tips[0].text : 'No tips available :(';\n\n            dest.nearbyVenues.bounds.extend(marker._marker.getPosition());\n\n            // Add marker and infoWindow events\n            marker.event.click(function() {\n              infoWindow.open(marker._marker);\n            });\n\n            infoWindow.event.close(function() {\n              infoWindow.close();\n            });\n\n            return venue;\n          }));\n          self.venues(dest.nearbyVenues);\n        })\n        .fail(function(xhr, status, error) {\n          self.hasError('Venues do not exist or cannot be loaded! Check the connection or the firewall.');\n          console.log(xhr.status, status, error);\n          throw error;\n        });\n    };\n  }\n\n  return LocationViewModel;\n});\n"]}